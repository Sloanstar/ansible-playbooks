---
######### IMAGE VERIFY ###############
- name: Run Verify For Image - verify disk0:/{{ asaAsdmImage }}
  asa_command:
    commands:
      - verify disk0:/{{ asaAsdmImage }}
  register: _asdmVerify
  failed_when: "'error' in _asdmVerify.stdout[0]|lower"
  tags: asdmDeploy

# TODO - ASA will ouput variable text on signature validation.
# Sometimes just "Signature verified"
# Other versions will display an embedded and computed hash.
# Write a block that looks for signature verified, if not it goes deeper into checksums.
# Basic Validation - Look for signature verified.
- name: Check for Signature Verified
  set_fact:
    asaAsdmVerified: true
  when: >
    ("'signature verified' in _asdmVerify.stdout[0]|lower") or
    ("'signature successfully validated' in _asdmVerify.stdout[0]|lower")
  tags: asdmDeploy
  # Basic Validation Univailable - Check for and compare embedded checksums.
- name: Checksum Validation Block
  block:
    - name: Get Embedded Checksum
      set_fact:
        asdmEmbedded: "{{ item.split(':')[1]|trim }}"
      when:
        - "item|trim|lower is search('embedded')"
      with_items:
        - "{{ _asdmVerify.stdout_lines[0] }}"
      tags: asdmDeploy

    - name: Get Computed Checksum
      set_fact:
        asdmComputed: "{{ item.split(':')[1]|trim }}"
      register: _setChecksum
      when: "item|trim|lower is search('computed')"
      with_items:
        - "{{ _asdmVerify.stdout_lines[0] }}"
      failed_when: >
        (asdmEmbedded == "") or
        (asdmComputed == "") or
        (asdmEmbedded != asdmComputed)
      tags: asdmDeploy

    - name: Debug _asdmVerify.stdout_lines[0]
      debug:
        msg: "line: {{ item }}"
        verbosity: 3
      with_items:
        - "{{ _asdmVerify.stdout_lines[0] }}"
      tags: asdmDeploy
 
    - name: Log Passed Checksum
      debug:
        msg: "\nFile checksum OK!\n{{ asdmComputed }}\n"
      when: asdmEmbedded == asdmComputed
      tags: asdmDeploy
  
    - name: Log Failed Checksum
      debug:
        msg: "\nasdmEmbedded: {{ asdmEmbedded }}\nasdmComputed: {{ asdmComputed }}\n"
      when: asdmEmbedded != Computed
      tags: asdmDeploy
    - name: Set ASA ASDM Verified
      set_fact:
        asaAsdmVerified: true
      when: asdmEmbedded == asdmComputed
      tags: asdmDeploy
  when:
    - asaAsdmVerified == false
# TODO: Build in validation from calculated checksum against stored variable.
# TODO: Last ditch effort to verify.
# TODO: Will require getting checksums from Cisco Website for images.
######### END IMAGE VERIFY ###############